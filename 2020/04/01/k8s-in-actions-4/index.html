<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>《K8S in Actions》 第四章学习笔记 - 大白的碎碎念</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="bwangel" /><meta name="description" content="副本机制和其他控制器 &amp;ndash; 部署托管的 Pod
" /><meta name="keywords" content="Hugo, blog, bwangel" />






<meta name="generator" content="Hugo 0.54.0 with theme even" />


<link rel="canonical" href="/2020/04/01/k8s-in-actions-4/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.6c8ff178.min.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="《K8S in Actions》 第四章学习笔记" />
<meta property="og:description" content="副本机制和其他控制器 &ndash; 部署托管的 Pod" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/2020/04/01/k8s-in-actions-4/" />
<meta property="article:published_time" content="2020-04-01T21:21:52&#43;08:00"/>
<meta property="article:modified_time" content="2020-04-01T21:21:52&#43;08:00"/>

<meta itemprop="name" content="《K8S in Actions》 第四章学习笔记">
<meta itemprop="description" content="副本机制和其他控制器 &ndash; 部署托管的 Pod">


<meta itemprop="datePublished" content="2020-04-01T21:21:52&#43;08:00" />
<meta itemprop="dateModified" content="2020-04-01T21:21:52&#43;08:00" />
<meta itemprop="wordCount" content="2839">



<meta itemprop="keywords" content="Kubernetes,笔记," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="《K8S in Actions》 第四章学习笔记"/>
<meta name="twitter:description" content="副本机制和其他控制器 &ndash; 部署托管的 Pod"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Keep Foolish</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">主页</li>
      </a><a href="/leetcode/">
        <li class="mobile-menu-item">LeetCode</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/translate/">
        <li class="mobile-menu-item">翻译</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Keep Foolish</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">主页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/leetcode/">LeetCode</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/translate/">翻译</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">《K8S in Actions》 第四章学习笔记</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-04-01 </span>
        
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#保持-pod-健康">保持 Pod 健康</a>
<ul>
<li><a href="#存活探针">存活探针</a></li>
<li><a href="#创建一个-http-get-探针">创建一个 HTTP GET 探针</a>
<ul>
<li><a href="#准备工作">准备工作</a></li>
<li><a href="#创建-pod-查看探针">创建 Pod &amp; 查看探针</a></li>
<li><a href="#修改存活探针的选项">修改存活探针的选项</a></li>
</ul></li>
<li><a href="#创建存活探针的注意事项">创建存活探针的注意事项</a>
<ul>
<li><a href="#1-探针应该只检查应用内部的状态">1. 探针应该只检查应用内部的状态</a></li>
<li><a href="#2-探针应该是轻量的">2. 探针应该是轻量的</a></li>
<li><a href="#3-探针中的操作无需重试">3. 探针中的操作无需重试</a></li>
</ul></li>
</ul></li>
<li><a href="#了解-replicationcontroller">了解 ReplicationController</a>
<ul>
<li><a href="#介绍">介绍</a></li>
<li><a href="#创建-replicationcontroller">创建 ReplicationController</a></li>
<li><a href="#通过删除-pod-来看-rc-的自动恢复能力">通过删除 Pod 来看 RC 的自动恢复能力</a></li>
<li><a href="#通过停止节点来查看-rc-的自动恢复能力">通过停止节点来查看 RC 的自动恢复能力</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>副本机制和其他控制器 &ndash; 部署托管的 Pod</p>

<hr />

<h2 id="保持-pod-健康">保持 Pod 健康</h2>

<p>如果容器的主进程崩溃或存活探针检查失败，K8S 会自动重启容器，通过这种方式来让容器获得了自我修复的能力。</p>

<p>这个操作是由节点上的 kubelet 执行的，在主服务器上运行的 K8S Control Plane 组件不会参与此过程。</p>

<h3 id="存活探针">存活探针</h3>

<p>存活探针 (<code>liveness probe</code>) 可以用来定期检查容器是否还在正常运行，从而决定是否重启容器。</p>

<p>存活探针有三种:</p>

<ol>
<li><code>HTTP GET 探针</code>:
GET 容器的 HTTP 地址，检查响应码是否是 2xx 或 3xx</li>
<li><code>TCP 探针</code>:
测试能否与容器的指定端口建立 TCP 连接</li>
<li><code>Exec 指针</code>:
在容器内执行某个命令，检查命令的返回码是否是0</li>
</ol>

<h3 id="创建一个-http-get-探针">创建一个 HTTP GET 探针</h3>

<h4 id="准备工作">准备工作</h4>

<ol>
<li>修改 kubia 程序，设置请求5次<code>/</code>接口后，程序就会返回 500，kubia 程序的代码在 <a href="https://github.com/bwangelme/kubia/tree/v0.2">bwangelme/kubia@v0.2</a>。</li>
<li>根据上述代码，重新创建一个镜像，<a href="https://hub.docker.com/r/bwangel/kubia/tags">bwangel/kubia:v0.2</a></li>
</ol>

<h4 id="创建-pod-查看探针">创建 Pod &amp; 查看探针</h4>

<ul>
<li>kubia-liveness.yaml</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">apiVersion<span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>Pod<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>kubia-unhealthy<span class="w">
</span><span class="w"></span>spec<span class="p">:</span><span class="w">
</span><span class="w">  </span>containers<span class="p">:</span><span class="w">
</span><span class="w">    </span>-<span class="w"> </span>image<span class="p">:</span><span class="w"> </span>bwangel/kubia<span class="p">:</span>v0.<span class="m">2</span><span class="w">
</span><span class="w">      </span>name<span class="p">:</span><span class="w"> </span>kubiame<span class="w">
</span><span class="w">      </span>livenessProbe<span class="p">:</span><span class="w">
</span><span class="w">        </span>httpGet<span class="p">:</span><span class="w">
</span><span class="w">          </span>path<span class="p">:</span><span class="w"> </span>/<span class="w">
</span><span class="w">          </span>port<span class="p">:</span><span class="w"> </span><span class="m">8080</span></code></pre></td></tr></table>
</div>
</div>
<p>通过 <code>spec.containers.image.livenessProbe</code> 我们创建了一个 HTTP GET 存活探针。</p>

<ul>
<li>创建 &amp; 查看 Pod</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">ø&gt; kubectl create -f kubia-liveness.yaml
pod/kubia-unhealthy created

ø&gt; kubectl get pod
NAME              READY   STATUS             RESTARTS   AGE
kubia-unhealthy   <span class="m">0</span>/1     CrashLoopBackOff   <span class="m">11</span>         30m
<span class="c1"># RESTARTS 表示 Pod 已经重启了11次，目前 Pod 正处于 CrashLoopBackOff 状态</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">ø&gt; kubectl describe pod kubia-unhealthy
Name:         kubia-unhealthy
Namespace:    default
Priority:     <span class="m">0</span>
Node:         gke-demo-default-pool-ade08258-zjhd/10.140.0.10
Start Time:   Wed, <span class="m">01</span> Apr <span class="m">2020</span> <span class="m">22</span>:07:04 +0800
Labels:       &lt;none&gt;
Annotations:  kubernetes.io/limit-ranger: LimitRanger plugin set: cpu request <span class="k">for</span> container kubiame
Status:       Running
IP:           <span class="m">10</span>.0.2.2
IPs:          &lt;none&gt;
Containers:
  kubiame:
    Container ID:   docker://6eb920af09115cb21564045fbc8ced0251e3aaecd5e7482142ecbf8ace3439e5
    Image:          bwangel/kubia:v0.2
    Image ID:       docker-pullable://bwangel/kubia@sha256:a89eaf3503fc72dc1e8c702142faefa6aeb59860c9472c1ee3e7e8154771be43
    Port:           &lt;none&gt;
    Host Port:      &lt;none&gt;
    State:          Waiting
      Reason:       CrashLoopBackOff
    <span class="c1"># 先前的容器被 Signal INT(2) 终止了</span>
    Last State:     Terminated
      Reason:       Error
      Exit Code:    <span class="m">2</span>
      Started:      Wed, <span class="m">01</span> Apr <span class="m">2020</span> <span class="m">22</span>:34:48 +0800
      Finished:     Wed, <span class="m">01</span> Apr <span class="m">2020</span> <span class="m">22</span>:35:57 +0800
    Ready:          False
    <span class="c1"># 容器已经重启了11次了</span>
    Restart Count:  <span class="m">11</span>
    Requests:
      cpu:        100m
    <span class="c1"># 这里介绍了存活探针的属性</span>
    <span class="c1"># 探针将会在应用启动后延迟0秒开始检查，探针检查的超时时间为1秒，检查间隔为10秒，检查失败3次后重启应用</span>
    Liveness:     http-get http://:8080/ <span class="nv">delay</span><span class="o">=</span>0s <span class="nv">timeout</span><span class="o">=</span>1s <span class="nv">period</span><span class="o">=</span>10s <span class="c1">#success=1 #failure=3</span>
    Environment:  &lt;none&gt;
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-hbl2l <span class="o">(</span>ro<span class="o">)</span>
Conditions:
  Type              Status
  Initialized       True
  Ready             False
  ContainersReady   False
  PodScheduled      True
Volumes:
  default-token-hbl2l:
    Type:        Secret <span class="o">(</span>a volume populated by a Secret<span class="o">)</span>
    SecretName:  default-token-hbl2l
    Optional:    <span class="nb">false</span>
QoS Class:       Burstable
Node-Selectors:  &lt;none&gt;
Tolerations:     node.kubernetes.io/not-ready:NoExecute <span class="k">for</span> 300s
                 node.kubernetes.io/unreachable:NoExecute <span class="k">for</span> 300s
Events:
  Type     Reason     Age                   From                                          Message
  ----     ------     ----                  ----                                          -------
  Normal   Scheduled  33m                   default-scheduler                             Successfully assigned default/kubia-unhealthy to gke-demo-default-pool-ade08258-zjhd
  Normal   Pulling    33m                   kubelet, gke-demo-default-pool-ade08258-zjhd  Pulling image <span class="s2">&#34;bwangel/kubia:v0.2&#34;</span>
  Normal   Pulled     33m                   kubelet, gke-demo-default-pool-ade08258-zjhd  Successfully pulled image <span class="s2">&#34;bwangel/kubia:v0.2&#34;</span>
  Normal   Killing    29m <span class="o">(</span>x3 over 32m<span class="o">)</span>     kubelet, gke-demo-default-pool-ade08258-zjhd  Container kubiame failed liveness probe, will be restarted
  Normal   Created    29m <span class="o">(</span>x4 over 33m<span class="o">)</span>     kubelet, gke-demo-default-pool-ade08258-zjhd  Created container kubiame
  Normal   Started    29m <span class="o">(</span>x4 over 33m<span class="o">)</span>     kubelet, gke-demo-default-pool-ade08258-zjhd  Started container kubiame
  Normal   Pulled     29m <span class="o">(</span>x3 over 32m<span class="o">)</span>     kubelet, gke-demo-default-pool-ade08258-zjhd  Container image <span class="s2">&#34;bwangel/kubia:v0.2&#34;</span> already present on machine
  <span class="c1"># HTTP GET 存活探针检查失败，Pod 重启</span>
  Warning  Unhealthy  13m <span class="o">(</span>x25 over 32m<span class="o">)</span>    kubelet, gke-demo-default-pool-ade08258-zjhd  Liveness probe failed: HTTP probe failed with statuscode: <span class="m">500</span>
  Warning  BackOff    3m49s <span class="o">(</span>x78 over 26m<span class="o">)</span>  kubelet, gke-demo-default-pool-ade08258-zjhd  Back-off restarting failed container</code></pre></td></tr></table>
</div>
</div>
<ul>
<li><strong>注意:</strong> 当容器被强行终止时，会创建一个全新的容器，而不是重启原来的容器。</li>
</ul>

<p>所以如果想要看容器的失败日志，要通过<code>kubectl logs -f kubia-unhealthy --previous</code>命令，查看上一个容器的日志。</p>

<h4 id="修改存活探针的选项">修改存活探针的选项</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">spec<span class="p">:</span><span class="w">
</span><span class="w">  </span>containers<span class="p">:</span><span class="w">
</span><span class="w">      </span>livenessProbe<span class="p">:</span><span class="w">
</span><span class="w">        </span>httpGet<span class="p">:</span><span class="w">
</span><span class="w">          </span>path<span class="p">:</span><span class="w"> </span>/<span class="w">
</span><span class="w">          </span>port<span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">        </span>initialDelaySeconds<span class="p">:</span><span class="w"> </span><span class="m">15</span><span class="w">  </span><span class="c"># 设置应用启动15秒后，才开始探针检查</span></code></pre></td></tr></table>
</div>
</div>
<p>如果探针检测的延时很短，可能导致应用还没有完全启动就开始检测，但检测的结果始终是失败的，这样应用会被无限重启。</p>

<h3 id="创建存活探针的注意事项">创建存活探针的注意事项</h3>

<h4 id="1-探针应该只检查应用内部的状态">1. 探针应该只检查应用内部的状态</h4>

<p>例如 web 程序依赖的数据库崩溃了，web 程序的存活探针不应该返回失败，否则就会导致应用程序被无限重启，但这样并不能恢复数据库。</p>

<h4 id="2-探针应该是轻量的">2. 探针应该是轻量的</h4>

<p>探针的CPU执行时间会占用 Pod 的执行时间，重量的探针会让 Pod 的 CPU 执行时间变短。</p>

<p>Java 和 Python 应用，启动时解释器会执行一些初始化操作，耗费大量的时间。应该使用 HTTP GET 探针，而不应该使用 Exec 探针。</p>

<h4 id="3-探针中的操作无需重试">3. 探针中的操作无需重试</h4>

<p>K8S 在检查应用的探针时就会自动重试，故探针内部只用做一次检查就好，无需重试。</p>

<h2 id="了解-replicationcontroller">了解 ReplicationController</h2>

<h3 id="介绍">介绍</h3>

<p>ReplicationController 旨在创建和管理一个 Pod 的多个副本(replicas)，这就是它名字的由来，ReplicationController 是通过标签来查看和管理容器。</p>

<p>ReplicationController 由三部分组成:</p>

<ol>
<li>Label Selector(标签选择器)，用于确定 ReplicationController 的作用域中有哪些 Pod</li>
<li>Replica Count(副本个数)，指定应该运行的 Pod 数量。</li>
<li>Pod template(Pod 模板)，用于创建新的 Pod 副本</li>
</ol>

<p><strong>注意:</strong> ReplicationController 管理的 Pod 不会从一个节点迁移到另一个节点上，它只会在另一个节点上新建一个 Pod，或者删除当前节点上的 Pod。</p>

<h3 id="创建-replicationcontroller">创建 ReplicationController</h3>

<p>以下是创建一个 ReplicationController 的示例文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">apiVersion<span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>ReplicationController<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>kubia<span class="w">
</span><span class="w"></span>spec<span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># 定义了 RC 的副本个数和标签选择器属性</span><span class="w">
</span><span class="w">  </span>replicas<span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">  </span>selector<span class="p">:</span><span class="w">
</span><span class="w">    </span>app<span class="p">:</span><span class="w"> </span>kubia<span class="w">
</span><span class="w">  </span><span class="c"># template 定义了 Pod 模板</span><span class="w">
</span><span class="w">  </span>template<span class="p">:</span><span class="w">
</span><span class="w">    </span>metadata<span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># 注意这里定义的标签要和 spec.selector 中定义的标签一致，否则 RC 就会不停地创建 Pod</span><span class="w">
</span><span class="w">      </span>labels<span class="p">:</span><span class="w">
</span><span class="w">        </span>app<span class="p">:</span><span class="w"> </span>kubia<span class="w">
</span><span class="w">    </span>spec<span class="p">:</span><span class="w">
</span><span class="w">      </span>containers<span class="p">:</span><span class="w">
</span><span class="w">        </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>kubia<span class="w">
</span><span class="w">          </span>image<span class="p">:</span><span class="w"> </span>bwangel/kubia<span class="p">:</span>v0.<span class="m">1</span><span class="w">
</span><span class="w">          </span>ports<span class="p">:</span><span class="w">
</span><span class="w">            </span>-<span class="w"> </span>containerPort<span class="p">:</span><span class="w"> </span><span class="m">8080</span></code></pre></td></tr></table>
</div>
</div>
<p><strong>注意:</strong> 模板文件可以不指定选择器(spec.selector)，让 K8S 自动从 Pod 模板中提取标签配置</p>

<ul>
<li>创建好 RC 后，我们可以查看 集群中的 Pod，可以看到已经有对应标签的 Pod 被创建了</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">ø&gt; kubectl get pod --show-labels
NAME          READY   STATUS              RESTARTS   AGE   LABELS
kubia-8fnnc   <span class="m">1</span>/1     Running             <span class="m">0</span>          36s   <span class="nv">app</span><span class="o">=</span>kubia
kubia-gswk6   <span class="m">0</span>/1     ContainerCreating   <span class="m">0</span>          36s   <span class="nv">app</span><span class="o">=</span>kubia
kubia-q865j   <span class="m">1</span>/1     Running             <span class="m">0</span>          36s   <span class="nv">app</span><span class="o">=</span>kubia</code></pre></td></tr></table>
</div>
</div>
<ul>
<li>查看 RC 的详细信息</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">ø&gt; kubectl describe rc kubia
Name:         kubia
Namespace:    default
Selector:     <span class="nv">app</span><span class="o">=</span>kubia
Labels:       <span class="nv">app</span><span class="o">=</span>kubia
Annotations:  &lt;none&gt;
Replicas:     <span class="m">3</span> current / <span class="m">3</span> desired  <span class="c1"># 副本的实际数量和期望数量</span>
Pods Status:  <span class="m">3</span> Running / <span class="m">0</span> Waiting / <span class="m">0</span> Succeeded / <span class="m">0</span> Failed  <span class="c1"># 当前各个状态的 Pod 数量</span>
Pod Template:
  Labels:  <span class="nv">app</span><span class="o">=</span>kubia
  Containers:
   kubia:
    Image:        bwangel/kubia:v0.1
    Port:         <span class="m">8080</span>/TCP
    Host Port:    <span class="m">0</span>/TCP
    Environment:  &lt;none&gt;
    Mounts:       &lt;none&gt;
  Volumes:        &lt;none&gt;
<span class="c1"># 这里列出了 RC 的事件</span>
Events:
  Type    Reason            Age   From                    Message
  ----    ------            ----  ----                    -------
  Normal  SuccessfulCreate  6m7s  replication-controller  Created pod: kubia-8fnnc
  Normal  SuccessfulCreate  6m7s  replication-controller  Created pod: kubia-gswk6
  Normal  SuccessfulCreate  6m7s  replication-controller  Created pod: kubia-q865j</code></pre></td></tr></table>
</div>
</div>
<h3 id="通过删除-pod-来看-rc-的自动恢复能力">通过删除 Pod 来看 RC 的自动恢复能力</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 查看当前所有的 Pod</span>
ø&gt; kubectl get pod --show-labels
NAME          READY   STATUS    RESTARTS   AGE     LABELS
kubia-8fnnc   <span class="m">1</span>/1     Running   <span class="m">0</span>          9m36s   <span class="nv">app</span><span class="o">=</span>kubia
kubia-gswk6   <span class="m">1</span>/1     Running   <span class="m">0</span>          9m36s   <span class="nv">app</span><span class="o">=</span>kubia
kubia-q865j   <span class="m">1</span>/1     Running   <span class="m">0</span>          9m36s   <span class="nv">app</span><span class="o">=</span>kubia

<span class="c1"># 删除某个特定的 Pod</span>
ø&gt; kubectl delete pod kubia-q865j
pod <span class="s2">&#34;kubia-q865j&#34;</span> deleted

<span class="c1"># 可以看到 RC 又重建了一个 Pod</span>
ø&gt; kubectl get pod --show-labels
NAME          READY   STATUS    RESTARTS   AGE   LABELS
kubia-2c592   <span class="m">1</span>/1     Running   <span class="m">0</span>          14s   <span class="nv">app</span><span class="o">=</span>kubia
kubia-8fnnc   <span class="m">1</span>/1     Running   <span class="m">0</span>          10m   <span class="nv">app</span><span class="o">=</span>kubia
kubia-gswk6   <span class="m">1</span>/1     Running   <span class="m">0</span>          10m   <span class="nv">app</span><span class="o">=</span>kubia

<span class="c1"># 查看 RC 的详细信息</span>
ø&gt; kubectl describe rc kubia
Name:         kubia
Selector:     <span class="nv">app</span><span class="o">=</span>kubia
Labels:       <span class="nv">app</span><span class="o">=</span>kubia
Replicas:     <span class="m">3</span> current / <span class="m">3</span> desired
Pods Status:  <span class="m">3</span> Running / <span class="m">0</span> Waiting / <span class="m">0</span> Succeeded / <span class="m">0</span> Failed
Pod Template:
  Labels:  <span class="nv">app</span><span class="o">=</span>kubia
Events:
  Type    Reason            Age   From                    Message
  ----    ------            ----  ----                    -------
  Normal  SuccessfulCreate  11m   replication-controller  Created pod: kubia-8fnnc
  Normal  SuccessfulCreate  11m   replication-controller  Created pod: kubia-gswk6
  Normal  SuccessfulCreate  11m   replication-controller  Created pod: kubia-q865j
  <span class="c1"># 可以看到新增了一个新建 Pod 的事件</span>
  Normal  SuccessfulCreate  85s   replication-controller  Created pod: kubia-2c592</code></pre></td></tr></table>
</div>
</div>
<p>当 K8S 的 API 服务器收到删除某个 Pod 的请求后，会将该事件通知相关的 RC。RC 收到事件通知后会去检查实际的 Pod 数量并采取适当的措施。</p>

<p>RC 不会对删除 Pod 操作本身做出反应，而是对删除 Pod 操作导致的状态 <code>Pod 数量不足</code> 做出了反应。</p>

<h3 id="通过停止节点来查看-rc-的自动恢复能力">通过停止节点来查看 RC 的自动恢复能力</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 查看当前 Pod 的状态</span>
ø&gt; kubectl get pod --show-labels -o<span class="o">=</span>wide
NAME          READY   STATUS    RESTARTS   AGE     IP         NODE                                  NOMINATED NODE   READINESS GATES   LABELS
kubia-2c592   <span class="m">1</span>/1     Running   <span class="m">0</span>          3m24s   <span class="m">10</span>.0.2.5   gke-demo-default-pool-ade08258-zjhd   &lt;none&gt;           &lt;none&gt;            <span class="nv">app</span><span class="o">=</span>kubia
kubia-8fnnc   <span class="m">1</span>/1     Running   <span class="m">0</span>          13m     <span class="m">10</span>.0.2.4   gke-demo-default-pool-ade08258-zjhd   &lt;none&gt;           &lt;none&gt;            <span class="nv">app</span><span class="o">=</span>kubia
kubia-gswk6   <span class="m">1</span>/1     Running   <span class="m">0</span>          13m     <span class="m">10</span>.0.1.5   gke-demo-default-pool-ade08258-g3rl   &lt;none&gt;           &lt;none&gt;            <span class="nv">app</span><span class="o">=</span>kubia

<span class="c1"># 停掉 gke-demo-default-pool-ade08258-g3rl 节点</span>
ø&gt; gcloud compute ssh gke-demo-default-pool-ade08258-g3rl
Welcome to Kubernetes v1.14.10-gke.27!

You can find documentation <span class="k">for</span> Kubernetes at:
  http://docs.kubernetes.io/

The <span class="nb">source</span> <span class="k">for</span> this release can be found at:
  /home/kubernetes/kubernetes-src.tar.gz
Or you can download it at:
  https://storage.googleapis.com/kubernetes-release-gke/release/v1.14.10-gke.27/kubernetes-src.tar.gz

It is based on the Kubernetes <span class="nb">source</span> at:
  https://github.com/kubernetes/kubernetes/tree/v1.14.10-gke.27

For Kubernetes copyright and licensing information, see:
  /home/kubernetes/LICENSES

<span class="c1"># 通过关闭网卡来停掉这个节点</span>
michaeltsui@gke-demo-default-pool-ade08258-g3rl ~ $ sudo ifconfig eth0 down
packet_write_wait: Connection to <span class="m">35</span>.234.11.33 port <span class="m">22</span>: Broken pipe
ERROR: <span class="o">(</span>gcloud.compute.ssh<span class="o">)</span> <span class="o">[</span>/usr/bin/ssh<span class="o">]</span> exited with <span class="k">return</span> code <span class="o">[</span><span class="m">255</span><span class="o">]</span>.

<span class="c1"># 查看所有节点的状态，发现被停掉节点的状态变成了 NotReady</span>
ø&gt; kubectl get node --show-labels
NAME                                  STATUS     ROLES    AGE   VERSION
gke-demo-default-pool-ade08258-g3rl   NotReady   &lt;none&gt;   47h   v1.14.10-gke.27
gke-demo-default-pool-ade08258-vqx4   Ready      &lt;none&gt;   19d   v1.14.10-gke.27
gke-demo-default-pool-ade08258-zjhd   Ready      &lt;none&gt;   19d   v1.14.10-gke.27

<span class="c1"># 查看 Pod 的状态，发现新建了一个 Pod kubia-fxkbc</span>
<span class="c1"># 被停掉节点上的 Pod kubia-gswk6 的状态变成了 Unknown</span>
ø&gt; kubectl get pods --show-labels -o<span class="o">=</span>wide
NAME          READY   STATUS    RESTARTS   AGE    IP         NODE                                  NOMINATED NODE   READINESS GATES   LABELS
kubia-2c592   <span class="m">1</span>/1     Running   <span class="m">0</span>          16m    <span class="m">10</span>.0.2.5   gke-demo-default-pool-ade08258-zjhd   &lt;none&gt;           &lt;none&gt;            <span class="nv">app</span><span class="o">=</span>kubia
kubia-8fnnc   <span class="m">1</span>/1     Running   <span class="m">0</span>          26m    <span class="m">10</span>.0.2.4   gke-demo-default-pool-ade08258-zjhd   &lt;none&gt;           &lt;none&gt;            <span class="nv">app</span><span class="o">=</span>kubia
kubia-fxkbc   <span class="m">1</span>/1     Running   <span class="m">0</span>          112s   <span class="m">10</span>.0.2.6   gke-demo-default-pool-ade08258-zjhd   &lt;none&gt;           &lt;none&gt;            <span class="nv">app</span><span class="o">=</span>kubia
kubia-gswk6   <span class="m">1</span>/1     Unknown   <span class="m">0</span>          26m    <span class="m">10</span>.0.1.5   gke-demo-default-pool-ade08258-g3rl   &lt;none&gt;           &lt;none&gt;            <span class="nv">app</span><span class="o">=</span>kubia

<span class="c1"># 恢复被停掉的节点</span>
ø&gt; gcloud compute instances reset gke-demo-default-pool-ade08258-g3rl
Updated <span class="o">[</span>https://www.googleapis.com/compute/v1/projects/braided-turbine-271114/zones/asia-east1-c/instances/gke-demo-default-pool-ade08258-g3rl<span class="o">]</span>.

Updates are available <span class="k">for</span> some Cloud SDK components.  To install them,
please run:
  $ gcloud components update

To take a quick anonymous survey, run:
  $ gcloud survey

<span class="c1"># 查看 K8S 集群中的节点也恢复了</span>
ø&gt; kubectl get node
NAME                                  STATUS   ROLES    AGE   VERSION
gke-demo-default-pool-ade08258-g3rl   Ready    &lt;none&gt;   47h   v1.14.10-gke.27
gke-demo-default-pool-ade08258-vqx4   Ready    &lt;none&gt;   19d   v1.14.10-gke.27
gke-demo-default-pool-ade08258-zjhd   Ready    &lt;none&gt;   19d   v1.14.10-gke.27

<span class="c1"># 节点恢复后，查看 Pod 会发现刚刚状态为 Unknown 的 Pod 被删除了。</span>
ø&gt; kubectl get pods --show-labels -o<span class="o">=</span>wide
NAME          READY   STATUS    RESTARTS   AGE     IP         NODE                                  NOMINATED NODE   READINESS GATES   LABELS
kubia-2c592   <span class="m">1</span>/1     Running   <span class="m">0</span>          19m     <span class="m">10</span>.0.2.5   gke-demo-default-pool-ade08258-zjhd   &lt;none&gt;           &lt;none&gt;            <span class="nv">app</span><span class="o">=</span>kubia
kubia-8fnnc   <span class="m">1</span>/1     Running   <span class="m">0</span>          29m     <span class="m">10</span>.0.2.4   gke-demo-default-pool-ade08258-zjhd   &lt;none&gt;           &lt;none&gt;            <span class="nv">app</span><span class="o">=</span>kubia
kubia-fxkbc   <span class="m">1</span>/1     Running   <span class="m">0</span>          5m35s   <span class="m">10</span>.0.2.6   gke-demo-default-pool-ade08258-zjhd   &lt;none&gt;           &lt;none&gt;            <span class="nv">app</span><span class="o">=</span>kubia</code></pre></td></tr></table>
</div>
</div>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">bwangel</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2020-04-01
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content">本博客所有文章除特别声明外，均采用 <a href='http://creativecommons.org/licenses/by-nc-sa/3.0/cn/' rel='external nofollow' target='_blank'>CC BY-NC-SA 3.0 CN</a> 许可协议。转载请注明出处</span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kubernetes/">Kubernetes</a>
          <a href="/tags/%E7%AC%94%E8%AE%B0/">笔记</a>
          </div>
      <nav class="post-nav">
        
        <a class="next" href="/2020/03/28/es-note/">
            <span class="next-text nav-default">ElasticSearch 学习笔记</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="anotherbwangel/blog-comment"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:bwangel.me@email.com" class="iconfont icon-email" title="email"></a>
      <a href="https://stackoverflow.com/users/5161084/bwangel" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
      <a href="https://twitter.com/bwangel23" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://github.com/bwangelme" class="iconfont icon-github" title="github"></a>
      <a href="https://www.douban.com/people/bwangel/" class="iconfont icon-douban" title="douban"></a>
  <a href="/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2016 - 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author"><a href='https://bwangel.me/about'>bwangel</a></span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
      TeX: {equationNumbers: {autoNumber: "AMS"}},
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"  integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>

<script id="baidu_analytics">
  var _hmt = _hmt || [];
  (function() {
    if (window.location.hostname === 'localhost') return;
    var hm = document.createElement("script"); hm.async = true;
    hm.src = "https://hm.baidu.com/hm.js?f22fe9c7aece3dedec2af9976b092478";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script>






</body>
</html>
